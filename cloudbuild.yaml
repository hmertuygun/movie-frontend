steps:
  # 1. Sending info to Slack
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args: 
      - '-eEuo'
      - 'pipefail'
      - '-c'
      - |-
        if [ $PROJECT_ID == 'coinpanel-dev' ]; then 
          gcloud pubsub topics publish cloud-builds-custom --message '{"build": "$BUILD_ID", "branch": "$BRANCH_NAME", "repo": "$REPO_NAME"}' ; 
        fi
  - name: 'ubuntu'
    args: ['mv', '.env-${_CLUSTER_TYPE}', '.env']
  #- name: 'ubuntu'
  #  args: ['mv', 'public/maintainence.html', 'public/index.html']
  - name: node:12.10.0
    entrypoint: yarn
    args: ['install']
  - name: node:12.10.0
    entrypoint: yarn
    args: ['run', 'build']
  - name: 'gcr.io/cloud-builders/docker'
    args: ["build", "-t", "gcr.io/$PROJECT_ID/cp-web-server:$SHORT_SHA", "."]
  - name: 'gcr.io/cloud-builders/docker'
    args: ["push", "gcr.io/$PROJECT_ID/cp-web-server:$SHORT_SHA"]
  - name: 'gcr.io/cloud-builders/gcloud'
    id: Setup
    args: ['container', 'clusters', 'get-credentials', 'cp-${_CLUSTER_TYPE}-cluster-eu', '--region=europe-north1', '--project=$PROJECT_ID']
  - name: 'ubuntu'
    id: preDeploy
    #dir: 'server'
    args: ['sh', 'deployment-helper/replacer.sh', '$SHORT_SHA', '$PROJECT_ID']
  - name: 'gcr.io/cloud-builders/kubectl'
    id: Deploy
    #dir: 'server'
    args:
      - 'apply'
      - '-f'
      - 'deployment.yaml'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=europe-north1'
      - 'CLOUDSDK_CONTAINER_CLUSTER=cp-${_CLUSTER_TYPE}-cluster-eu'
substitutions:
  _CLUSTER_TYPE: ${PROJECT_ID:10}
timeout: 1200s
options:
  dynamic_substitutions: true

